sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/BusyDialog"],function(e,t,a,o,r){"use strict";return e.extend("dashboard.controller.Complaint",{sSavedPath:"",complaintNumber:"",onInit:function(){var e=new a({VendorNumber:"",VendorFirstName:"",VendorLastName:"",VendorEmail:"",VendorPhoneNumber:"",PONumber:"",PurchasingGrp:"",InvoiceNumber:"",PODescription:"",ComplaintDesc:"",ComplaintCategory:"",ComplaintNumber:"",Status:""});this.getView().setModel(e,"vendor");var t=new a({items:null,fileNames:"",aFileNames:null});this.getView().setModel(t,"FileModel");var o=sap.ui.core.UIComponent.getRouterFor(this);o.getRoute("complaintDetails").attachPatternMatched(this._onObjectMatched,this)},saveData:function(){var e=this.getView();var t=e.getModel("vendor");var a=t.getData();this.complaintNumber="COM"+this.generateRandomNumber();var r="In_Progress";var n=e.byId("complaintDescInput").getValue();var i=e.byId("complaintCategoryInput").getSelectedKey();if(!n||!i){o.error("Please fill in all mandatory fields.");return}var s=this.getView().getModel("FileModel");var l=s.getData();if(l.items==null){o.error("Please attach at least one file.");return}var d={ComplaintDesc:n,ComplaintCategory:i,ComplaintNumber:this.complaintNumber,Status:r};console.log(d);var g="07557707-df9d-4f21-a852-912e791b52fc.complaints.dashboard-0.0.1/odata/v4/vendor";var c=g+this.sSavedPath;$.ajax({url:c,type:"PATCH",contentType:"application/json",data:JSON.stringify(d),success:function(e){console.log("Entity updated successfully:",e)},error:function(e){console.error("Error updating entity:",e)}});this.postFiles()},generateRandomNumber:function(){var e=1e6;var t=9999999;return Math.floor(Math.random()*(t-e+1))+e},_createEntity:function(e,t){var a=this.getView().getModel("vendor");var o=a.getData();var r=this.getView().getModel("FileModel");var n=r.getData();var i={VendorNumber:o.VendorNumber,ItemNumber:t,FileType:e.type,FileName:e.name};var s={url:"/odata/v4/vendor/Document",method:"POST",headers:{"Content-type":"application/json"},data:JSON.stringify(i)};return new Promise((e,t)=>{$.ajax(s).done((t,a,o)=>{e(t.ID);console.log("Posted")}).fail(e=>{t(e)})})},_updateEntity:function(e,t,a){var o=this.getView().getModel("vendor");var r=o.getData();var n=this.getView().getModel("FileModel");var i=n.getData();var s=new FileReader;s.onload=t=>{var o=t.target.result;var r={url:`/odata/v4/vendor/Document(${a})/content`,method:"PUT",headers:{"Content-Type":e.type},processData:false,data:o};$.ajax(r).done((e,t,a)=>{console.log("Posted",e)}).fail(e=>{console.error("Error posting file content:",e)})};s.readAsArrayBuffer(e)},postFiles:function(){var e=this;var t=new sap.m.BusyDialog({title:"Please wait",text:"Posting files and data...",showCancelButton:false});t.open();var a=this.getView().getModel("FileModel");var r=a.getData();console.log(r);var n=[];for(var i=0;i<r.items.length;i++){var s=r.items[i];n.push(this._createEntity(s,i+1))}Promise.all(n).then(e=>{var t=[];for(var a=0;a<r.items.length;a++){var o=r.items[a];var n=e[a];t.push(this._updateEntity(o,a+1,n))}return Promise.all(t)}).then(()=>{t.close();o.success(`Complaint Registered : ${this.complaintNumber}`,{onClose:function(){e.onNavToDashboard()}})}).catch(e=>{t.close();console.error("Error posting files:",e);sap.m.MessageToast.show("Error posting files and data: "+e)})},onNavToDashboard:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("TargetDashboard",{},true)},_showMessageDialog:function(e,t){o.information(t,{title:e,actions:[o.Action.OK]})},post:function(e){var t=e.getSource();var a=t.getBindingContext("afileNames");var o=a.getPath();var r=a.getObject();var n=o.split("/").pop();var i=this.getView().getModel("FileModel");var s=i.getData();var l=s.items[n];console.log(l);this._createEntity(l,parseInt(n)+1).then(e=>{this._updateEntity(l,parseInt(n)+1,e);r.status="completed";console.log(r);var t=this.getView().getModel("afileNames");var a=t.getData();console.log(a);this.getView().setModel(t,"afileNames")}).catch(e=>{MessageToast.show("Error creating document entity: "+e.message)})},_onObjectMatched:function(e){this.sSavedPath=decodeURIComponent(e.getParameter("arguments").path);var t=this.getView().getModel();var a=t.bindContext(this.sSavedPath);a.requestObject().then(function(e){var t=this.getView().getModel("vendor");t.setData(e);console.log(this.getView().getModel("vendor").getData())}.bind(this)).catch(function(e){console.error(e)})},onNavBack:function(){var e=t.getInstance();var a=e.getPreviousHash();if(a!==undefined){window.history.go(-1)}else{var o=sap.ui.core.UIComponent.getRouterFor(this);o.navTo("TargetDashboard",{},true)}},openDialog:async function(){this.oDialog??=await this.loadFragment({name:"vendor.view.fileUpload"});this.getView().addDependent(this.oDialog);this.oDialog.open()},_openFile:function(e){var t=e.getParameter("files");var o=this.getView().getModel("FileModel");var r=o.getData();r.items=t;console.log(t);var n=[];var i=[];for(var s=0;s<t.length;s++){i.push({name:t[s].name,status:"Pending"})}var l=n.join(", ");r.fileNames=l;r.aFileNames=i;console.log(r.aFileNames);var d=new a({item:r.aFileNames});this.getView().setModel(d,"afileNames");this.getView().byId("fileUploader").setEnabled(false);this.getView().byId("fileUploader").setValueState(sap.ui.core.ValueState.Success)}})});
//# sourceMappingURL=Complaint.controller.js.map